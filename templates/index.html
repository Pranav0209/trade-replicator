<!DOCTYPE html>
<html>
  <head>
    <title>Zerodha Trade Replicator</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background: #f5f5f7;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      h1 {
        margin-top: 0;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .status-connected {
        color: green;
        font-weight: bold;
      }

      .status-pending {
        color: orange;
        font-weight: bold;
      }

      .status-expired {
        color: #ff3b30;
        font-weight: bold;
      }

      .btn {
        display: inline-block;
        padding: 8px 16px;
        background: #007aff;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
      }

      .btn:hover {
        background: #0056b3;
      }

      .tag {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .tag-master {
        background: #e3f2fd;
        color: #1565c0;
      }

      .tag-child {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background: white;
        width: 400px;
        padding: 24px;
        border-radius: 12px;
        margin: 100px auto;
        position: relative;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      .btn-secondary {
        background: #e5e5ea;
        color: #333;
      }

      .btn-secondary:hover {
        background: #d1d1d6;
      }

      .btn-row {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
      }
    </style>
  </head>

  <body>
    <h1>Zerodha Trade Replicator</h1>

    <div class="card">
      <h2>Account Status</h2>
      <table>
        <thead>
          <tr>
            <th>Account ID</th>
            <th>Type</th>
            <th>Configured Capital</th>
            <th>Max Cap Usage</th>
            <th>Status</th>
            <th>Last Updated</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for acc in accounts %}
          <tr>
            <td>{{ acc.account_id }}</td>
            <td>
              {% if acc.is_master %}
              <span class="tag tag-master">MASTER</span>
              {% else %}
              <span class="tag tag-child">CHILD</span>
              {% endif %}
            </td>
            <td>{{ acc.capital | inr }}</td>
            <td>
              {% if acc.max_capital_usage and acc.max_capital_usage > 0 %} {{
              acc.max_capital_usage | inr }} {% else %}
              <span style="color: #999">Unlimited</span>
              {% endif %}
            </td>
            <td
              class="{{ 'status-connected' if acc.status == 'connected' else 'status-expired' if acc.status == 'expired' else 'status-pending' }}"
            >
              {{ 'LOGIN REQ' if acc.status == 'expired' else acc.status.upper()
              }}
            </td>
            <td>{{ acc.last_updated | datetime }}</td>
            <td>
              <div class="action-buttons">
                <a
                  href="/auth/login?account_id={{ acc.account_id }}"
                  class="btn"
                  >Login</a
                >
                <button
                  onclick="openEditModal('{{ acc.account_id }}', '{{ acc.max_capital_usage | default(0, true) }}')"
                  class="btn btn-secondary"
                >
                  Edit
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Instructions</h3>
      <ol>
        <li>Click "Login to Zerodha" for <b>each</b> account above.</li>
        <li>You will be redirected to Kite Login.</li>
        <li>After successful login, you will be redirected back here.</li>
        <li>
          Ensure all accounts show
          <span class="status-connected">CONNECTED</span> before starting the
        </li>
      </ol>
    </div>

    <div class="card">
      <h3>System Controls</h3>
      <p>Use these actions to manage the replication engine state.</p>
      <div class="action-buttons">
        <button
          onclick="confirmResetStrategy()"
          class="btn"
          style="background-color: #ff3b30"
        >
          Reset Strategy State
        </button>
      </div>
      <small style="color: #666; margin-top: 8px; display: block">
        * Clears the "Frozen Ratio" and resets the cycle. Use this at the start
        of a new trade cycle (e.g., Wednesday morning).
      </small>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3>Edit Account Configuration</h3>
        <div class="form-group">
          <label>Account ID</label>
          <input
            type="text"
            id="editAccountId"
            disabled
            style="background: #f5f5f7"
          />
        </div>
        <div class="form-group">
          <label>Max Capital Usage (â‚¹)</label>
          <input
            type="number"
            id="editMaxCapital"
            placeholder="Enter 0 for Unlimited"
          />
          <small style="color: #666; display: block; margin-top: 4px"
            >Set to 0 to use full available capital.</small
          >
        </div>
        <div class="btn-row">
          <button onclick="closeModal()" class="btn btn-secondary">
            Cancel
          </button>
          <button onclick="saveAccount()" class="btn">Save</button>
        </div>
      </div>
    </div>

    <script>
      function openEditModal(accountId, maxCap) {
        document.getElementById("editAccountId").value = accountId;
        document.getElementById("editMaxCapital").value = maxCap;
        document.getElementById("editModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      async function confirmResetStrategy() {
        if (
          confirm(
            "Are you sure you want to RESET the Strategy State?\n\nThis will clear the current 'Frozen Ratio' and is irreversible.\nOnly do this if you are starting a fresh trade cycle."
          )
        ) {
          try {
            const response = await fetch("/trading/reset-strategy", {
              method: "POST",
            });

            if (response.ok) {
              alert("Strategy State has been reset successfully.");
              location.reload();
            } else {
              alert("Failed to reset strategy.");
            }
          } catch (e) {
            console.error(e);
            alert("Error calling reset endpoint.");
          }
        }
      }

      async function saveAccount() {
        const accountId = document.getElementById("editAccountId").value;
        const raw = document.getElementById("editMaxCapital").value;
        const maxCap = raw ? parseFloat(raw) : 0;

        try {
          const response = await fetch(`/accounts/${accountId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ max_capital_usage: maxCap }),
          });

          if (response.ok) {
            location.reload();
          } else {
            alert("Failed to update account");
          }
        } catch (e) {
          console.error(e);
          alert("Error updating account");
        }
      }

      // Close modal on outside click
      window.onclick = function (event) {
        if (event.target == document.getElementById("editModal")) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
